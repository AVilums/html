<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="csv.js"></script>
    <script type="text/javascript" src="file.js"></script>

    <h1>Izvēlēties darba failus:</h1>

    <form id="myForm">
        <label for="csvFile">Pievienojiet <b>stukturvienibas.csv</b> failus</label>
        <input type="file" id="csvFile" accept=".csv" />
        <br/>
    </form>

    <h1>Stuktūrvienības pievienošana</h1>
    
    <script>
        var strukturasViss;  //viss fails 2d masīvā

        const struktura = []; // struktūru nosaukumu masīvs
        const strukturaId = []; //struktūru id masīvs

        // Handle multiple fileuploads     
        document.getElementById("csvFile").addEventListener("change", function (ev) {
            let files = ev.currentTarget.files;
            let readers = [];

            // Abort if there were no files selected
            if (!files.length) return;

            // Store promises in array
            for (let i = 0; i < files.length; i++) {
                readers.push(readFileAsText(files[i]));
            }

            Promise.all(readers).then((values) => {
                let viens = stringTo2dArray(values[0], "!", ",");
                compare(viens);
            });

        }, false);

        function compare(viens, divi, tris) {
            if (viens[0][0] == "Str.ID") {
                strukturasViss = forpush(viens);
            } else {
                alert("Izvēlēts nepareizais fails");
                window.open("pievienots.html", "_self");
            }
        }

        function arrayToCSV() {
            //  Modified from: http://stackoverflow.com/questions/17836273/
            //  export-javascript-data-to-csv-file-without-server-interaction
            var csvRows = [];
            var temp;

            for (let i = 0; i < strukturasViss.length - 1; i++) {
                temp = "";

                for (let j = 0; j < strukturasViss[i].length; j++) {
                    if (j < strukturasViss[i].length - 1) {
                        temp = temp + strukturasViss[i][j] + ",";
                    } else {
                        temp = temp + strukturasViss[i][j] + "!";
                    }
                }
                csvRows[i] = temp;
            }

            for (let i = 0; i < csvRows.length; i++) {
                alert("Row:  " + i + "  :" + csvRows[i]);
            }

            var universalBOM = "\uFEFF";

            const data = strukturasViss;
            let csvContent = "data:text/csv;charset=utf-8," + universalBOM + data.map(e => e.join(","));

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "strukturvienibas.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>

</head>

<body>
    <form><label for="stukturasid">Struktūrvienības ID:&nbsp; </label><input type="text" id="stukturasid"
            name="stukturasid" size="24pt"></p>
        <p><label for="strukturname">Struktūrvienības nosaukums: </label><input type="text" id="strukturname"
                name="strukturname" size="16pt"></p>
        <p><label for="strukturnameen">Name of structure: </label><input type="text" id="strukturnameen"
                name="strukturnameen" size="26pt"></p>
        <button onclick="arrayToCSV()">Pievienot</button>
    </form>
</body>

</html>